name: Test Onboarding and Offboarding Workflows

on:
  # Trigger on changes to workflow files
  push:
    paths:
      - '.github/workflows/*.yml'
  # Monthly scheduled run (1st of each month at 00:00 UTC)
  schedule:
    - cron: '0 0 1 * *'
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  test-workflows:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Select random reviewer
        id: select-reviewer
        run: |
          reviewers=("Bai-Li-NOAA" "kellijohnson-NOAA" "Schiano-NOAA")
          selected_reviewer=${reviewers[$RANDOM % ${#reviewers[@]}]}
          echo "reviewer=${selected_reviewer}" >> $GITHUB_OUTPUT
          echo "Selected reviewer: ${selected_reviewer}"
      
      - name: Create test issue from template
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const reviewer = '${{ steps.select-reviewer.outputs.reviewer }}';
            
            // CONFIGURATION 
            const templatePath = '.github/ISSUE_TEMPLATE/add_new_profile.yml';
            
            const fieldData = {
              'profile-name': 'Test User (Automated)',
              'email': 'test.user@email.com',
              'github-username': 'test-user-automated',
              'onboarding-date': new Date().toISOString().split('T')[0],
              'offboarding-date': new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
              'role-affiliation': 'Fishery Biologist, ST4 National Stock Assessment Program',
              'biography': 'This is an automated test profile created to validate workflows.',
            };

            try {
              if (!fs.existsSync(templatePath)) {
                throw new Error(`Template file not found at ${templatePath}`);
              }
              const content = fs.readFileSync(templatePath, 'utf8');

              // 1. Construct the Red Flag Warning
              let markdownBody = `> [!CAUTION]
            > **AUTOMATED TEST RUN**
            >
            > **Reviewer (@${reviewer}):** Please review the profile and checklist below to ensure they display correctly. 
            >
            > This issue was created automatically to test the onboarding/offboarding workflows.\n\n`;

              // 2. Parse the YAML Body
              const bodyParts = content.split(/^body:/m);
              if (bodyParts.length < 2) throw new Error("Could not find 'body:' section in YAML");
              
              const rawBody = bodyParts[1];
              
              // Matches "- type:" followed by content until the next "- type:" or end of file
              const blockRegex = /-\s+type:\s+(\w+)[\s\S]*?(?=(?:-\s+type:|$))/g;
              let match;

              while ((match = blockRegex.exec(rawBody)) !== null) {
                const block = match[0];
                const type = match[1];

                const labelMatch = block.match(/label:\s*(.*)/);
                const label = labelMatch ? labelMatch[1].trim() : null;

                const idMatch = block.match(/id:\s*(.*)/);
                const id = idMatch ? idMatch[1].trim() : null;

                let staticValue = null;
                if (block.includes('value: |')) {
                   const valueParts = block.split('value: |');
                   if (valueParts[1]) {
                     const lines = valueParts[1].split('\n').slice(1);
                     const validLines = [];
                     let baseIndent = -1;

                     for (const line of lines) {
                       // 1. Skip checks for empty lines, just add them
                       if (line.trim().length === 0) {
                         validLines.push('');
                         continue;
                       }

                       // 2. Calculate indentation of current line
                       const currentIndent = line.search(/\S/);

                       // 3. Establish the "Base Indentation" from the first non-empty line
                       if (baseIndent === -1) {
                         baseIndent = currentIndent;
                       }

                       // 4. STOP if indentation drops below the base (detects next YAML key)
                       if (currentIndent < baseIndent) {
                         break;
                       }

                       // 5. Remove the indentation (slice the string)
                       // This prevents Markdown from thinking it's a code block
                       validLines.push(line.slice(baseIndent));
                     }
                     staticValue = validLines.join('\n').trim();
                   }
                }
                // ------------------------------------

                // --- BUILD MARKDOWN ---
                if (type === 'markdown' && staticValue) {
                  markdownBody += `${staticValue}\n\n`;
                  continue;
                }

                if (label) {
                  markdownBody += `### ${label}\n\n`;
                  
                  if (id && fieldData[id]) {
                    markdownBody += `${fieldData[id]}\n\n`;
                  } else if (staticValue) {
                      markdownBody += `${staticValue}\n\n`;
                  } else {
                    markdownBody += `_No test data provided for ${id || 'this field'}_\n\n`;
                  }
                }
              }

              // 3. Create the issue
              const issueTitle = '[Test Profile]: Test User (Automated Test)';
              const labels = ['automated-test'];
              
              let issue;
              try {
                issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: markdownBody,
                  labels: labels,
                  assignees: [reviewer]
                });
              } catch (assignError) {
                console.log(`Warning: Could not assign reviewer: ${assignError.message}`);
                issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: issueTitle,
                  body: markdownBody,
                  labels: labels
                });
              }
              
              console.log(`Created test issue #${issue.data.number}`);
              return issue.data.number;

            } catch (error) {
              core.setFailed(`Failed to create issue from template: ${error.message}`);
            }
      
      - name: Get onboard workflows
        id: get-onboard-workflows
        run: |
          cd .github/workflows
          onboard_workflows=$(ls onboard-*.yml onboard-*.yaml 2>/dev/null | sed 's/onboard-//' | sed 's/\.yml$//' | sed 's/\.yaml$//' | tr '\n' ' ' || echo "")
          echo "workflows=${onboard_workflows}" >> $GITHUB_OUTPUT
          echo "Onboard workflows: ${onboard_workflows}"
      
      - name: Get offboard workflows
        id: get-offboard-workflows
        run: |
          cd .github/workflows
          offboard_workflows=$(ls offboard-*.yml offboard-*.yaml 2>/dev/null | sed 's/offboard-//' | sed 's/\.yml$//' | sed 's/\.yaml$//' | tr '\n' ' ' || echo "")
          echo "workflows=${offboard_workflows}" >> $GITHUB_OUTPUT
          echo "Offboard workflows: ${offboard_workflows}"
      
      - name: Test onboarding workflows
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.result }};
            const workflows = '${{ steps.get-onboard-workflows.outputs.workflows }}'.trim().split(' ').filter(w => w.length > 0);
            
            console.log(`Testing ${workflows.length} onboarding workflows on issue #${issueNumber}`);
            
            for (const workflow of workflows) {
              const command = `/onboard-${workflow}`;
              console.log(`Posting command: ${command}`);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: command
              });
              
              // Wait 5 seconds between commands to ensure reliable triggering
              await new Promise(resolve => setTimeout(resolve, 5000));
            }
      
      - name: Wait between onboard and offboard workflows
        run: |
          echo "Waiting 10 seconds before starting offboard workflows..."
          sleep 10
      
      - name: Test offboarding workflows
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.result }};
            const workflows = '${{ steps.get-offboard-workflows.outputs.workflows }}'.trim().split(' ').filter(w => w.length > 0);
            
            console.log(`Testing ${workflows.length} offboarding workflows on issue #${issueNumber}`);
            
            for (const workflow of workflows) {
              const command = `/offboard-${workflow}`;
              console.log(`Posting command: ${command}`);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: command
              });
              
              // Wait 5 seconds between commands to ensure reliable triggering
              await new Promise(resolve => setTimeout(resolve, 5000));
            }
      
      - name: Add test completion comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const issueNumber = ${{ steps.create-issue.outputs.result }};
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const onboardWorkflows = '${{ steps.get-onboard-workflows.outputs.workflows }}'.trim().split(' ').filter(w => w.length > 0);
            const offboardWorkflows = '${{ steps.get-offboard-workflows.outputs.workflows }}'.trim().split(' ').filter(w => w.length > 0);
            
            const workflowList = [
              '**Onboarding workflows tested** (' + onboardWorkflows.length + '):',
              ...onboardWorkflows.map(w => `- /onboard-${w}`),
              '',
              '**Offboarding workflows tested** (' + offboardWorkflows.length + '):',
              ...offboardWorkflows.map(w => `- /offboard-${w}`)
            ].join('\n');
            
            // 3 minutes delay (3 * 60 * 1000 ms)
            await new Promise(resolve => setTimeout(resolve, 180000));

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `:white_check_mark: **Automated workflow testing completed**\n\nAll onboarding and offboarding workflow commands have been posted to this issue. Please verify that the workflows executed correctly by checking the comments above.\n\n${workflowList}\n\n**Workflow run:** ${runUrl}\n\n`
            });
            
            console.log(`Test completed for issue #${issueNumber}`);
